<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PhotoCaptureManager.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.fitquest.app.ui.fragments.coach</a> &gt; <span class="el_source">PhotoCaptureManager.kt</span></div><h1>PhotoCaptureManager.kt</h1><pre class="source lang-java linenums">package com.fitquest.app.ui.fragments.coach

import android.content.Context
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.graphics.Matrix
import androidx.camera.core.ImageCapture
import androidx.camera.core.ImageCaptureException
import androidx.exifinterface.media.ExifInterface
import com.fitquest.app.ui.coachutils.counter.PlankTimer
import java.io.File
import java.io.FileOutputStream
import java.util.concurrent.Executor

<span class="fc" id="L15">class PhotoCaptureManager(</span>
<span class="fc" id="L16">    private val context: Context</span>
) {
<span class="fc" id="L18">    private val bottomRepPhotoFiles = mutableListOf&lt;File&gt;()</span>
<span class="fc" id="L19">    private var lastCapturedRepIndex: Int = -1</span>
    private var lastCaptureTimeMs: Long = 0L

<span class="fc" id="L22">    fun getPhotos(): List&lt;File&gt; = bottomRepPhotoFiles</span>

    fun clear() {
<span class="fc" id="L25">        bottomRepPhotoFiles.clear()</span>
<span class="fc" id="L26">        lastCapturedRepIndex = -1</span>
<span class="fc" id="L27">        lastCaptureTimeMs = 0L</span>
<span class="fc" id="L28">    }</span>

    /**
     * 조건에 맞으면 사진 캡처 시도
     * @return 캡처를 시도했는지 여부
     */
    fun captureIfNeeded(
        imageCapture: ImageCapture?,
        executor: Executor,
        exerciseName: String,
        currentRep: Int,
        phase: String?
    ): Boolean {
<span class="fc" id="L41">        val nowMs = System.currentTimeMillis()</span>
<span class="fc" id="L42">        val lowerName = exerciseName.lowercase()</span>

        // 촬영 조건 확인
<span class="fc" id="L45">        val phaseOk = when (lowerName) {</span>
<span class="fc bfc" id="L46" title="All 2 branches covered.">            &quot;plank&quot; -&gt; phase == PlankTimer.Phase.HOLDING.name</span>
<span class="fc bfc" id="L47" title="All 4 branches covered.">            else -&gt; (phase == &quot;BOTTOM&quot; || phase == &quot;DOWN_REACHED&quot;)</span>
        }
<span class="fc bfc" id="L49" title="All 2 branches covered.">        if (!phaseOk) return false</span>

        // 간격 확인
<span class="fc" id="L52">        val intervalMs = when (lowerName) {</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">            &quot;plank&quot; -&gt; CoachConstants.PLANK_CAPTURE_INTERVAL_MS</span>
<span class="fc" id="L54">            else -&gt; CoachConstants.MIN_CAPTURE_INTERVAL_MS</span>
        }
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (nowMs - lastCaptureTimeMs &lt; intervalMs) return false</span>

        // 스쿼트/런지는 같은 rep에서 중복 방지
<span class="pc bpc" id="L59" title="1 of 4 branches missed.">        if (lowerName != &quot;plank&quot; &amp;&amp; currentRep &lt;= lastCapturedRepIndex) return false</span>

<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        val capture = imageCapture ?: return false</span>

<span class="fc" id="L63">        val file = File(</span>
<span class="fc" id="L64">            context.externalCacheDir,</span>
<span class="fc" id="L65">            &quot;${CoachConstants.FILE_PREFIX_BOTTOM_REP}${currentRep}_${System.currentTimeMillis()}${CoachConstants.FILE_EXTENSION}&quot;</span>
        )

<span class="fc" id="L68">        val outputOptions = ImageCapture.OutputFileOptions.Builder(file).build()</span>
<span class="fc" id="L69">        lastCaptureTimeMs = nowMs</span>

<span class="fc" id="L71">        capture.takePicture(</span>
<span class="fc" id="L72">            outputOptions,</span>
<span class="fc" id="L73">            executor,</span>
<span class="fc" id="L74">            object : ImageCapture.OnImageSavedCallback {</span>
                override fun onError(exception: ImageCaptureException) {
                    // 실패해도 앱 진행
<span class="nc" id="L77">                }</span>

                override fun onImageSaved(outputFileResults: ImageCapture.OutputFileResults) {
<span class="fc" id="L80">                    try {</span>
<span class="fc" id="L81">                        correctImageOrientation(file)</span>
<span class="fc" id="L82">                        bottomRepPhotoFiles.add(file)</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">                        if (lowerName != &quot;plank&quot;) {</span>
<span class="fc" id="L85">                            lastCapturedRepIndex = currentRep</span>
                        }
<span class="nc" id="L87">                    } catch (e: Exception) {</span>
<span class="nc" id="L88">                        e.printStackTrace()</span>
                    }
<span class="fc" id="L90">                }</span>
            }
        )

<span class="fc" id="L94">        return true</span>
    }

    private fun correctImageOrientation(file: File) {
<span class="fc" id="L98">        val exif = ExifInterface(file.absolutePath)</span>
<span class="fc" id="L99">        val orientation = exif.getAttributeInt(</span>
<span class="fc" id="L100">            ExifInterface.TAG_ORIENTATION,</span>
<span class="fc" id="L101">            ExifInterface.ORIENTATION_NORMAL</span>
        )

<span class="fc" id="L104">        val bitmap = BitmapFactory.decodeFile(file.absolutePath)</span>
<span class="fc" id="L105">        val matrix = Matrix()</span>

<span class="pc bpc" id="L107" title="3 of 4 branches missed.">        when (orientation) {</span>
<span class="nc" id="L108">            ExifInterface.ORIENTATION_ROTATE_90 -&gt; matrix.postRotate(90f)</span>
<span class="nc" id="L109">            ExifInterface.ORIENTATION_ROTATE_180 -&gt; matrix.postRotate(180f)</span>
<span class="fc" id="L110">            ExifInterface.ORIENTATION_ROTATE_270 -&gt; matrix.postRotate(270f)</span>
        }

<span class="fc" id="L113">        val rotated = Bitmap.createBitmap(</span>
<span class="fc" id="L114">            bitmap, 0, 0, bitmap.width, bitmap.height, matrix, true</span>
        )

<span class="pc" id="L117">        FileOutputStream(file).use { out -&gt;</span>
<span class="fc" id="L118">            rotated.compress(Bitmap.CompressFormat.JPEG, 90, out)</span>
        }

<span class="fc" id="L121">        rotated.recycle()</span>
<span class="fc" id="L122">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>